generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String           @id @default(cuid())
  email                String           @unique
  name                 String
  password             String?
  role                 UserRole         @default(DISPATCHER)
  isActive             Boolean          @default(true)
  createdAt            DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime         @updatedAt @db.Timestamptz(6)
  lastLogin            DateTime?        @db.Timestamptz(6)
  accounts             Account[]
  auditLogs            AuditLog[]
  charterRequests      CharterRequest[] @relation("CharterRequestCreator")
  fixedContracts       FixedContract[]  @relation("FixedContractCreator")
  sessions             Session[]
  confirmedSettlements Settlement[]     @relation("SettlementConfirmer")
  settlements          Settlement[]     @relation("SettlementCreator")
  requests             Request[]        @relation("RequestCreator")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime @db.Timestamptz(6)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime @db.Timestamptz(6)

  @@unique([identifier, token])
  @@map("verificationtokens")
}

model Driver {
  id                                      String           @id @default(cuid())
  name                                    String
  phone                                   String
  businessNumber                          String?
  bankName                                String?
  accountNumber                           String?
  remarks                                 String?
  isActive                                Boolean          @default(true)
  createdAt                               DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt                               DateTime         @updatedAt @db.Timestamptz(6)
  vehicleNumber                           String
  businessName                            String?
  representative                          String?
  charterRequests                         CharterRequest[] @relation("CharterRequestDriver")
  fixedContracts                          FixedContract[]  @relation("FixedContractDriver")
  routeTemplates                          RouteTemplate[]  @relation("RouteDefaultDriver")
  settlements                             Settlement[]     @relation("DriverSettlements")
  dispatches                              Dispatch[]       @relation("DispatchDriver")

  @@unique([name, phone, vehicleNumber], name: "unique_driver_info")
  @@index([name])
  @@index([phone])
  @@index([vehicleNumber])
  @@index([isActive])
  @@index([name, phone, vehicleNumber], map: "idx_driver_composite")
  @@map("drivers")
}

model LoadingPoint {
  id               String           @id @default(cuid())
  isActive         Boolean          @default(true)
  createdAt        DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime         @updatedAt @db.Timestamptz(6)
  centerName       String
  loadingPointName String
  lotAddress       String?
  roadAddress      String?
  manager1         String?
  manager2         String?
  phone1           String?
  phone2           String?
  remarks          String?
  charterRequests  CharterRequest[] @relation("CharterRequestCenter")
  fixedContracts   FixedContract[]  @relation("FixedContractLoadingPoint")
  routeTemplates   RouteTemplate[]

  @@index([centerName])
  @@index([loadingPointName])
  @@index([isActive])
  @@map("loading_points")
}

model RouteTemplate {
  id              String        @id @default(cuid())
  name            String        @unique
  loadingPoint    String
  distance        Float?
  driverFare      Decimal       @db.Decimal(12, 2)
  billingFare     Decimal       @db.Decimal(12, 2)
  weekdayPattern  Int[]
  defaultDriverId String?
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime      @updatedAt @db.Timestamptz(6)
  loadingPointId  String?
  defaultDriver   Driver?       @relation("RouteDefaultDriver", fields: [defaultDriverId], references: [id])
  loadingPointRef LoadingPoint? @relation(fields: [loadingPointId], references: [id])

  @@index([name])
  @@index([loadingPoint])
  @@index([loadingPointId])
  @@index([defaultDriverId])
  @@index([isActive])
  @@map("route_templates")
}

model Settlement {
  id              String           @id @default(cuid())
  yearMonth       String
  driverId        String
  status          SettlementStatus @default(DRAFT)
  totalTrips      Int              @default(0)
  totalBaseFare   Decimal          @default(0) @db.Decimal(12, 2)
  totalDeductions Decimal          @default(0) @db.Decimal(12, 2)
  totalAdditions  Decimal          @default(0) @db.Decimal(12, 2)
  finalAmount     Decimal          @default(0) @db.Decimal(12, 2)
  confirmedAt     DateTime?        @db.Timestamptz(6)
  confirmedBy     String?
  paidAt          DateTime?        @db.Timestamptz(6)
  createdAt       DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime         @updatedAt @db.Timestamptz(6)
  createdBy       String?
  items           SettlementItem[]
  confirmer       User?            @relation("SettlementConfirmer", fields: [confirmedBy], references: [id])
  creator         User?            @relation("SettlementCreator", fields: [createdBy], references: [id])
  driver          Driver           @relation("DriverSettlements", fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([driverId, yearMonth], name: "unique_driver_yearmonth")
  @@index([yearMonth, status])
  @@index([driverId, status])
  @@index([status, confirmedAt])
  @@map("settlements")
}

model SettlementItem {
  id           String             @id @default(cuid())
  settlementId String
  type         SettlementItemType
  description  String
  amount       Decimal            @db.Decimal(12, 2)
  date         DateTime           @db.Date
  createdAt    DateTime           @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime           @updatedAt @db.Timestamptz(6)
  settlement   Settlement         @relation(fields: [settlementId], references: [id], onDelete: Cascade)

  @@index([settlementId, type])
  @@index([date])
  @@map("settlement_items")
}

model AuditLog {
  id         String      @id @default(cuid())
  userId     String?
  userName   String
  action     AuditAction
  entityType String
  entityId   String
  changes    Json?
  metadata   Json?
  createdAt  DateTime    @default(now()) @db.Timestamptz(6)
  user       User?       @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([entityType, entityId])
  @@index([action, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

model RegionAlias {
  id             String   @id @default(cuid())
  rawText        String   @unique
  normalizedText String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @db.Timestamptz(6)

  @@index([normalizedText])
  @@index([rawText])
  @@map("region_aliases")
}

model FixedContract {
  id                 String        @id @default(cuid())
  driverId           String?
  loadingPointId     String
  routeName          String
  centerContractType ContractType
  driverContractType ContractType?
  centerAmount       Decimal       @db.Decimal(12, 2)
  driverAmount       Decimal?      @db.Decimal(12, 2)
  operatingDays      Int[]
  startDate          DateTime?     @db.Date
  specialConditions  String?
  remarks            String?
  isActive           Boolean       @default(true)
  createdAt          DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime      @updatedAt @db.Timestamptz(6)
  createdBy          String?
  endDate            DateTime?     @db.Date
  creator            User?         @relation("FixedContractCreator", fields: [createdBy], references: [id])
  driver             Driver?       @relation("FixedContractDriver", fields: [driverId], references: [id])
  loadingPoint       LoadingPoint  @relation("FixedContractLoadingPoint", fields: [loadingPointId], references: [id])

  @@unique([loadingPointId, routeName], name: "unique_center_route")
  @@index([driverId, isActive])
  @@index([loadingPointId, isActive])
  @@index([centerContractType])
  @@index([driverContractType])
  @@map("fixed_contracts")
}

model CenterFare {
  id             String   @id @default(cuid())
  centerName     String
  vehicleType    String
  region         String?
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @db.Timestamptz(6)
  fareType       FareType
  baseFare       Int?
  extraStopFee   Int?
  extraRegionFee Int?

  @@unique([centerName, vehicleType, region], name: "unique_center_vehicle_region")
  @@index([centerName, vehicleType])
  @@index([region])
  @@map("center_fares")
}

// NEW CHARTER MANAGEMENT SYSTEM - Request/Dispatch Architecture

model Request {
  id                String      @id @default(cuid())
  requestDate       DateTime    @db.Date
  centerCarNo       String      @db.VarChar(50)
  vehicleTon        Decimal     @db.Decimal(3,1)
  regions           Json        // Array of region names
  stops             Int
  notes             String?
  extraAdjustment   Int         @default(0)
  adjustmentReason  String?     // Reason for adjustment when != 0
  createdAt         DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime    @updatedAt @db.Timestamptz(6)
  createdBy         String?
  
  // Relations
  dispatches        Dispatch[]
  creator           User?       @relation("RequestCreator", fields: [createdBy], references: [id])
  
  // Enhanced indexes for performance
  @@index([requestDate, centerCarNo])
  @@index([requestDate])
  @@index([centerCarNo])
  @@index([createdAt])
  @@map("requests")
}

model Dispatch {
  id            String    @id @default(cuid())
  requestId     String
  driverId      String?   // Optional FK to drivers table
  driverName    String    // Manual entry when FK is null
  driverPhone   String
  driverVehicle String
  deliveryTime  String?   // e.g., "09~12ì‹œ"
  driverFee     Int
  driverNotes   String?
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(6)
  
  // Relations
  request       Request   @relation(fields: [requestId], references: [id], onDelete: Cascade)
  driver        Driver?   @relation("DispatchDriver", fields: [driverId], references: [id])
  
  // Enhanced indexes for query optimization
  @@index([requestId])
  @@index([driverId])
  @@index([requestId, driverId])
  @@index([createdAt])
  @@map("dispatches")
}

// LEGACY - Keep for migration purposes
model CharterRequest {
  id             String               @id @default(cuid())
  centerId       String
  vehicleType    String
  date           DateTime             @db.Date
  isNegotiated   Boolean              @default(false)
  negotiatedFare Int?
  baseFare       Int?
  regionFare     Int?
  stopFare       Int?
  extraFare      Int?
  totalFare      Int
  driverId       String
  driverFare     Int
  notes          String?
  createdAt      DateTime             @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime             @updatedAt @db.Timestamptz(6)
  createdBy      String?
  destinations   CharterDestination[]
  center         LoadingPoint         @relation("CharterRequestCenter", fields: [centerId], references: [id])
  creator        User?                @relation("CharterRequestCreator", fields: [createdBy], references: [id])
  driver         Driver               @relation("CharterRequestDriver", fields: [driverId], references: [id])

  @@index([centerId, date])
  @@index([driverId, date])
  @@index([vehicleType])
  @@index([date])
  @@index([createdAt])
  @@map("charter_requests")
}

model CharterDestination {
  id        String         @id @default(cuid())
  requestId String
  region    String
  order     Int
  request   CharterRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@unique([requestId, order], name: "unique_request_order")
  @@index([requestId])
  @@map("charter_destinations")
}



enum SettlementStatus {
  DRAFT
  CONFIRMED
  PAID
}

enum UserRole {
  ADMIN
  DISPATCHER
  ACCOUNTANT
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  IMPORT
  EXPORT
  CONFIRM
  ACTIVATE
  DEACTIVATE
  LOGIN
  LOGOUT
}

enum ContractType {
  FIXED_DAILY
  FIXED_MONTHLY
  CONSIGNED_MONTHLY
  CHARTER_PER_RIDE
}

enum FareType {
  BASIC
  STOP_FEE
}

enum SettlementItemType {
  TRIP
  DEDUCTION
  ADDITION
  ADJUSTMENT
}

